@load ./hash
@load base/frameworks/notice

module FileAnalysis;

export {
	redef enum Action += { ACTION_MHR_CHECK };
	
	global hash_sha1_actions: set[Action] = {ACTION_HASH_SHA1};
	redef action_dependencies += { [ACTION_MHR_CHECK] = hash_sha1_actions };
	
	redef enum Notice::Type += { 
		## The SHA1 sum of a file matched in the malware hash registry.
		Malware_Hash_Registry_Match
	};
	
	redef record Info += {
		mhr_match:    bool &log &optional;
	};
}

event FileAnalysis::trigger(f: Info, trig: Trigger) &priority=-5
	{
	if ( trig == IDENTIFIED_SHA1 && ACTION_MHR_CHECK in f$actions )
		{
		local hash_domain = fmt("%s.malware.hash.cymru.com", f$sha1);
		when ( local addrs = lookup_hostname(hash_domain) )
			{
			# 127.0.0.2 indicates that the sha1 sum was found in the MHR.
			if ( 127.0.0.2 in addrs )
				{
				local cid: conn_id;
				# This is a hack to just get one of the conn_ids.
				for ( tmp_cid in f$cids )
					cid = tmp_cid;
				#local url = HTTP::build_url_http(rec);
				local message = fmt("%s %s", cid$orig_h, f$sha1);
				NOTICE([$note=Malware_Hash_Registry_Match,
				        $msg=message, $id=cid]);
				}
			}
		}
	}